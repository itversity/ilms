
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Writing Basic SQL Queries &#8212; My Jupyter Book</title>
    
  <link rel="stylesheet" href="_static/css/index.73d71520a4ca3b99cfee5594769eaaae.css">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="_static/sphinx-book-theme.2d2078699c18a0efb88233928e1cf6ed.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.3da636dd464baa7582d2.js">

    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.be0a4a0c39cd630af62a2fcf693f3f06.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Creating Tables and Indexes" href="04_creating_tables_and_indexes.html" />
    <link rel="prev" title="Getting Started" href="01_getting_started.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="index.html">
  
  
  <h1 class="site-logo" id="site-title">My Jupyter Book</h1>
  
</a>
</div>

<form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="content.html">
   Mastering Postgresql
  </a>
 </li>
</ul>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="01_getting_started.html">
   Getting Started
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Writing Basic SQL Queries
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="04_creating_tables_and_indexes.html">
   Creating Tables and Indexes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="05_partitioning_tables_and_indexes.html">
   Partitioning Tables and Indexes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="06_predefined_functions.html">
   Pre-Defined Functions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="07_writing_advanced_sql_queries.html">
   Writing Advanced SQL Queries
  </a>
 </li>
</ul>

</nav>

 <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        <div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    
    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/03_writing_basic_sql_queries.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
    
</div>
        <!-- Source interaction buttons -->


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/executablebooks/jupyter-book/master?urlpath=tree/03_writing_basic_sql_queries.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#standard-transformations">
   Standard Transformations
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#overview-of-data-model">
   Overview of Data Model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#define-problem-statement-daily-product-revenue">
   Define Problem Statement – Daily Product Revenue
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#preparing-tables">
   Preparing Tables
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#selecting-or-projecting-data">
   Selecting or Projecting Data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#filtering-data">
   Filtering Data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#joining-tables-inner">
   Joining Tables – Inner
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#joining-tables-outer">
   Joining Tables - Outer
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#performing-aggregations">
   Performing Aggregations
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#sorting-data">
   Sorting Data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#solution-daily-product-revenue">
   Solution – Daily Product Revenue
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#exercises-basic-sql-queries">
   Exercises - Basic SQL Queries
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#exercise-1-customer-order-count">
     Exercise 1 - Customer order count
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#exercise-2-dormant-customers">
     Exercise 2 - Dormant Customers
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#exercise-3-revenue-per-customer">
     Exercise 3 - Revenue Per Customer
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#exercise-4-revenue-per-category">
     Exercise 4 - Revenue Per Category
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#exercise-5-product-count-per-department">
   Exercise 5 - Product Count Per Department
  </a>
 </li>
</ul>

        </nav>
        
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="writing-basic-sql-queries">
<h1>Writing Basic SQL Queries<a class="headerlink" href="#writing-basic-sql-queries" title="Permalink to this headline">¶</a></h1>
<p>As part of this section we will primarily focus on writing basic queries.</p>
<ul class="simple">
<li><p>Standard Transformations</p></li>
<li><p>Overview of Data Model</p></li>
<li><p>Define Problem Statement – Daily Product Revenue</p></li>
<li><p>Preparing Tables</p></li>
<li><p>Selecting or Projecting Data</p></li>
<li><p>Filtering Data</p></li>
<li><p>Joining Tables – Inner</p></li>
<li><p>Joining Tables – Outer</p></li>
<li><p>Performing Aggregations</p></li>
<li><p>Sorting Data</p></li>
<li><p>Solution – Daily Product Revenue</p></li>
</ul>
<div class="section" id="standard-transformations">
<h2>Standard Transformations<a class="headerlink" href="#standard-transformations" title="Permalink to this headline">¶</a></h2>
<p>Here are some of the transformations we typically perform on regular basis.</p>
<ul class="simple">
<li><p>Projection of data</p></li>
<li><p>Filtering data</p></li>
<li><p>Performing Aggregations</p></li>
<li><p>Joins</p></li>
<li><p>Sorting</p></li>
<li><p>Ranking (will be covered as part of advanced queries)</p></li>
</ul>
</div>
<div class="section" id="overview-of-data-model">
<h2>Overview of Data Model<a class="headerlink" href="#overview-of-data-model" title="Permalink to this headline">¶</a></h2>
<p>We will be using retail data model for this section. It contains 6 tables.</p>
<ul class="simple">
<li><p>Table list</p>
<ul>
<li><p>orders</p></li>
<li><p>order_items</p></li>
<li><p>products</p></li>
<li><p>categories</p></li>
<li><p>departments</p></li>
<li><p>customers</p></li>
</ul>
</li>
<li><p><strong>orders</strong> and <strong>order_items</strong> are transactional tables.</p></li>
<li><p><strong>products</strong>, <strong>categories</strong> and <strong>departments</strong> are non transactional tables which have data related to product catalog.</p></li>
<li><p><strong>customers</strong> is a non transactional table which have customer details.</p></li>
<li><p>There is 1 to many relationship between <strong>orders</strong> and <strong>order_items</strong>.</p></li>
<li><p>There is 1 to many relationship between <strong>products</strong> and <strong>order_items</strong>. Each order item will have one product and product can be part of many order_items.</p></li>
<li><p>There is 1 to many relationship between <strong>customers</strong> and <strong>orders</strong>. A customer can place many orders over a period of time but there cannot be more than one customer for a given order.</p></li>
<li><p>There is 1 to many relationship between <strong>departments</strong> and <strong>categories</strong>. Also there is 1 to many relationship between <strong>categories</strong> and <strong>products</strong>.</p></li>
<li><p>There is hierarchical relationship from departments to products - <strong>departments</strong> -&gt; <strong>categories</strong> -&gt; <strong>products</strong></p></li>
</ul>
</div>
<div class="section" id="define-problem-statement-daily-product-revenue">
<h2>Define Problem Statement – Daily Product Revenue<a class="headerlink" href="#define-problem-statement-daily-product-revenue" title="Permalink to this headline">¶</a></h2>
<p>Let us try to get daily product revenue using retail tables.</p>
<ul class="simple">
<li><p>daily is derived from orders.order_date.</p></li>
<li><p>product has to be derived from products.product_name.</p></li>
<li><p>revenue has to be derived from order_items.order_item_subtotal.</p></li>
<li><p>We need to join all the 3 tables, then group by order_date, product_id as well as product_name to get revenue using order_item_subtotal.</p></li>
<li><p>Get Daily Product Revenue using products, orders and order_items data set.</p></li>
<li><p>We have following fields in <strong>orders</strong>.</p>
<ul>
<li><p>order_id</p></li>
<li><p>order_date</p></li>
<li><p>order_customer_id</p></li>
<li><p>order_status</p></li>
</ul>
</li>
<li><p>We have following fields in <strong>order_items</strong>.</p>
<ul>
<li><p>order_item_id</p></li>
<li><p>order_item_order_id</p></li>
<li><p>order_item_product_id</p></li>
<li><p>order_item_quantity</p></li>
<li><p>order_item_subtotal</p></li>
<li><p>order_item_product_price</p></li>
</ul>
</li>
<li><p>We have following fields in <strong>products</strong></p>
<ul>
<li><p>product_id</p></li>
<li><p>product_category_id</p></li>
<li><p>product_name</p></li>
<li><p>product_description</p></li>
<li><p>product_price</p></li>
<li><p>product_image</p></li>
</ul>
</li>
<li><p>We have one to many relationship between orders and order_items.</p></li>
<li><p><strong>orders.order_id</strong> is <strong>primary key</strong> and <strong>order_items.order_item_order_id</strong> is foreign key to <strong>orders.order_id</strong>.</p></li>
<li><p>We have one to many relationship between products and order_items.</p></li>
<li><p><strong>products.product_id</strong> is <strong>primary key</strong> and <strong>order_items.order_item_product_id</strong> is foreign key to <strong>oproducts.product_id</strong></p></li>
<li><p>By the end of this module we will explore all standard transformation and get daily product revenue using following fields.</p>
<ul>
<li><p><strong>orders.order_date</strong></p></li>
<li><p><strong>order_items.order_item_product_id</strong></p></li>
<li><p><strong>products.product_name</strong></p></li>
<li><p><strong>order_items.order_item_subtotal</strong> (aggregated using date and product_id).</p></li>
</ul>
</li>
<li><p>We will consider only <strong>COMPLETE</strong> or <strong>CLOSED</strong> orders.</p></li>
<li><p>As there can be more than one product names with different ids, we have to include product_id as part of the key using which we will group the data.</p></li>
</ul>
</div>
<div class="section" id="preparing-tables">
<h2>Preparing Tables<a class="headerlink" href="#preparing-tables" title="Permalink to this headline">¶</a></h2>
<p>Let us ensure we have all the tables are ready to come up with the solution for the problem statement.</p>
<ul class="simple">
<li><p>Ensure that we have required database and user for retail data. We might provide the database as part of our labs.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">psql</span> <span class="o">-</span><span class="n">U</span> <span class="n">postgres</span> <span class="o">-</span><span class="n">h</span> <span class="n">localhost</span> <span class="o">-</span><span class="n">p</span> <span class="mi">5433</span> <span class="o">-</span><span class="n">W</span>

<span class="n">CREATE</span> <span class="n">DATABASE</span> <span class="n">itversity_retail_db</span><span class="p">;</span>
<span class="n">CREATE</span> <span class="n">USER</span> <span class="n">itversity_retail_user</span> <span class="n">WITH</span> <span class="n">ENCRYPTED</span> <span class="n">PASSWORD</span> <span class="s1">&#39;retail_password&#39;</span><span class="p">;</span>
<span class="n">GRANT</span> <span class="n">ALL</span> <span class="n">ON</span> <span class="n">DATABASE</span> <span class="n">itversity_retail_db</span> <span class="n">TO</span> <span class="n">itversity_retail_user</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Create Tables using the script provided. You can either use <code class="docutils literal notranslate"><span class="pre">psql</span></code> or <strong>SQL Alchemy</strong>.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">psql</span> <span class="o">-</span><span class="n">U</span> <span class="n">itversity_retail_user</span> \
  <span class="o">-</span><span class="n">h</span> <span class="n">localhost</span> \
  <span class="o">-</span><span class="n">p</span> <span class="mi">5433</span> \
  <span class="o">-</span><span class="n">d</span> <span class="n">itversity_retail_db</span> \
  <span class="o">-</span><span class="n">W</span>

\<span class="n">i</span> <span class="n">retail_db</span><span class="o">/</span><span class="n">create_db_tables_pg</span><span class="o">.</span><span class="n">sql</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Data shall be loaded using the script provided.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>\<span class="n">i</span> <span class="n">retail_db</span><span class="o">/</span><span class="n">load_db_tables_pg</span><span class="o">.</span><span class="n">sql</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Run queries to validate we have data in all the 3 tables.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">7600</span><span class="n">c8b786e3</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">run_line_magic</span><span class="p">(</span><span class="s1">&#39;load_ext&#39;</span><span class="p">,</span> <span class="s1">&#39;sql&#39;</span><span class="p">)</span>

<span class="nn">~/Projects/Internal/bootcamp/ilms/ilms-env/lib/python3.7/site-packages/IPython/core/interactiveshell.py</span> in <span class="ni">run_line_magic</span><span class="nt">(self, magic_name, line, _stack_depth)</span>
<span class="g g-Whitespace">   </span><span class="mi">2324</span>                 <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;local_ns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_local_scope</span><span class="p">(</span><span class="n">stack_depth</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2325</span>             <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">builtin_trap</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">2326</span>                 <span class="n">result</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2327</span>             <span class="k">return</span> <span class="n">result</span>
<span class="g g-Whitespace">   </span><span class="mi">2328</span> 

<span class="nn">&lt;decorator-gen-57&gt;</span> in <span class="ni">load_ext</span><span class="nt">(self, module_str)</span>

<span class="nn">~/Projects/Internal/bootcamp/ilms/ilms-env/lib/python3.7/site-packages/IPython/core/magic.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(f, *a, **k)</span>
<span class="g g-Whitespace">    </span><span class="mi">185</span>     <span class="c1"># but it&#39;s overkill for just that one bit of state.</span>
<span class="g g-Whitespace">    </span><span class="mi">186</span>     <span class="k">def</span> <span class="nf">magic_deco</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">187</span>         <span class="n">call</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">:</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">188</span> 
<span class="g g-Whitespace">    </span><span class="mi">189</span>         <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>

<span class="nn">~/Projects/Internal/bootcamp/ilms/ilms-env/lib/python3.7/site-packages/IPython/core/magics/extension.py</span> in <span class="ni">load_ext</span><span class="nt">(self, module_str)</span>
<span class="g g-Whitespace">     </span><span class="mi">31</span>         <span class="k">if</span> <span class="ow">not</span> <span class="n">module_str</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">32</span>             <span class="k">raise</span> <span class="n">UsageError</span><span class="p">(</span><span class="s1">&#39;Missing module name.&#39;</span><span class="p">)</span>
<span class="ne">---&gt; </span><span class="mi">33</span>         <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">extension_manager</span><span class="o">.</span><span class="n">load_extension</span><span class="p">(</span><span class="n">module_str</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">34</span> 
<span class="g g-Whitespace">     </span><span class="mi">35</span>         <span class="k">if</span> <span class="n">res</span> <span class="o">==</span> <span class="s1">&#39;already loaded&#39;</span><span class="p">:</span>

<span class="nn">~/Projects/Internal/bootcamp/ilms/ilms-env/lib/python3.7/site-packages/IPython/core/extensions.py</span> in <span class="ni">load_extension</span><span class="nt">(self, module_str)</span>
<span class="g g-Whitespace">     </span><span class="mi">78</span>             <span class="k">if</span> <span class="n">module_str</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">79</span>                 <span class="k">with</span> <span class="n">prepended_to_syspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ipython_extension_dir</span><span class="p">):</span>
<span class="ne">---&gt; </span><span class="mi">80</span>                     <span class="n">mod</span> <span class="o">=</span> <span class="n">import_module</span><span class="p">(</span><span class="n">module_str</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">81</span>                     <span class="k">if</span> <span class="n">mod</span><span class="o">.</span><span class="vm">__file__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ipython_extension_dir</span><span class="p">):</span>
<span class="g g-Whitespace">     </span><span class="mi">82</span>                         <span class="nb">print</span><span class="p">((</span><span class="s2">&quot;Loading extensions from </span><span class="si">{dir}</span><span class="s2"> is deprecated. &quot;</span>

<span class="nn">/usr/local/opt/python@3.7/Frameworks/Python.framework/Versions/3.7/lib/python3.7/importlib/__init__.py</span> in <span class="ni">import_module</span><span class="nt">(name, package)</span>
<span class="g g-Whitespace">    </span><span class="mi">125</span>                 <span class="k">break</span>
<span class="g g-Whitespace">    </span><span class="mi">126</span>             <span class="n">level</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="ne">--&gt; </span><span class="mi">127</span>     <span class="k">return</span> <span class="n">_bootstrap</span><span class="o">.</span><span class="n">_gcd_import</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="n">level</span><span class="p">:],</span> <span class="n">package</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">128</span> 
<span class="g g-Whitespace">    </span><span class="mi">129</span> 

<span class="nn">/usr/local/opt/python@3.7/Frameworks/Python.framework/Versions/3.7/lib/python3.7/importlib/_bootstrap.py</span> in <span class="ni">_gcd_import</span><span class="nt">(name, package, level)</span>

<span class="nn">/usr/local/opt/python@3.7/Frameworks/Python.framework/Versions/3.7/lib/python3.7/importlib/_bootstrap.py</span> in <span class="ni">_find_and_load</span><span class="nt">(name, import_)</span>

<span class="nn">/usr/local/opt/python@3.7/Frameworks/Python.framework/Versions/3.7/lib/python3.7/importlib/_bootstrap.py</span> in <span class="ni">_find_and_load_unlocked</span><span class="nt">(name, import_)</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;sql&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5433/itversity_retail_db
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> SELECT current_database()
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM information_schema.tables 
WHERE table_catalog = &#39;itversity_retail_db&#39; 
    AND table_schema = &#39;public&#39; 
LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> SELECT * FROM orders LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> SELECT * FROM order_items LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> SELECT * FROM products LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> SELECT count(1) FROM orders
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> SELECT count(1) FROM order_items
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> SELECT count(1) FROM products
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="selecting-or-projecting-data">
<h2>Selecting or Projecting Data<a class="headerlink" href="#selecting-or-projecting-data" title="Permalink to this headline">¶</a></h2>
<p>Let us understand different aspects of projecting data. We primarily using <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> to project the data.</p>
<ul class="simple">
<li><p>We can project all columns using <code class="docutils literal notranslate"><span class="pre">*</span></code> or some columns using column names.</p></li>
<li><p>We can provide aliases to a column or expression using <code class="docutils literal notranslate"><span class="pre">AS</span></code> in <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> clause.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DISTINCT</span></code> can be used to get the distinct records from selected columns. We can also use <code class="docutils literal notranslate"><span class="pre">DISTINCT</span> <span class="pre">*</span></code> to get unique records using all the columns.</p></li>
<li><p>As part of <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> clause we can have aggregate functions such as <code class="docutils literal notranslate"><span class="pre">count</span></code>, <code class="docutils literal notranslate"><span class="pre">sum</span></code> etc.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5433/itversity_retail_db
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> SELECT * FROM orders LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> SELECT * FROM information_schema.columns WHERE table_catalog = &#39;itversity_retail_db&#39; AND table_name = &#39;orders&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> SELECT order_customer_id, order_date, order_status FROM orders LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> SELECT order_customer_id, to_char(order_date, &#39;yyyy-MM&#39;), order_status FROM orders LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> SELECT order_customer_id, to_char(order_date, &#39;yyyy-MM&#39;) AS order_month, order_status FROM orders LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> SELECT DISTINCT to_char(order_date, &#39;yyyy-MM&#39;) AS order_month FROM orders
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> SELECT count(1) FROM orders
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> SELECT count(DISTINCT to_char(order_date, &#39;yyyy-MM&#39;)) AS distinct_month_count FROM orders
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="filtering-data">
<h2>Filtering Data<a class="headerlink" href="#filtering-data" title="Permalink to this headline">¶</a></h2>
<p>Let us understand how we can filter the data as part of our queries.</p>
<ul class="simple">
<li><p>We use <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> clause to filter the data.</p></li>
<li><p>All comparison operators such as <code class="docutils literal notranslate"><span class="pre">=</span></code>, <code class="docutils literal notranslate"><span class="pre">!=</span></code>, <code class="docutils literal notranslate"><span class="pre">&gt;</span></code>, <code class="docutils literal notranslate"><span class="pre">&lt;</span></code>, etc can be used to compare a column or expression or literal with another column or expression or literal.</p></li>
<li><p>We can use operators such as <code class="docutils literal notranslate"><span class="pre">LIKE</span></code> with % and <code class="docutils literal notranslate"><span class="pre">regexp_matches</span></code> for pattern matching.</p></li>
<li><p>Boolan <code class="docutils literal notranslate"><span class="pre">OR</span></code> and <code class="docutils literal notranslate"><span class="pre">AND</span></code> can be performed when we want to apply multiple conditions.</p>
<ul>
<li><p>Get all orders with order_status equals to COMPLETE or CLOSED. We can also use IN operator.</p></li>
<li><p>Get all orders from month 2014 January with order_status equals to COMPLETE or CLOSED</p></li>
</ul>
</li>
<li><p>We need to use <code class="docutils literal notranslate"><span class="pre">IS</span> <span class="pre">NULL</span></code> and <code class="docutils literal notranslate"><span class="pre">IS</span> <span class="pre">NOT</span> <span class="pre">NULL</span></code> to compare against null values.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5433/itversity_retail_db
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> SELECT * FROM orders WHERE order_status = &#39;COMPLETE&#39; LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> SELECT count(1) FROM orders
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> SELECT count(1) FROM orders WHERE order_status = &#39;COMPLETE&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> SELECT * FROM orders WHERE order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;) LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> SELECT count(1) FROM orders WHERE order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> SELECT count(1) FROM orders WHERE order_status = &#39;COMPLETE&#39; OR order_status = &#39;CLOSED&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM orders 
WHERE order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
    AND to_char(order_date, &#39;yyyy-MM-dd&#39;) LIKE &#39;2014-01%&#39;
LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM orders 
WHERE order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
    AND to_char(order_date, &#39;yyyy-MM&#39;) = &#39;2014-01&#39;
LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT count(1) FROM orders 
WHERE order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
    AND to_char(order_date, &#39;yyyy-MM-dd&#39;) LIKE &#39;2014-01%&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT count(1) FROM orders 
WHERE order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
    AND to_char(order_date, &#39;yyyy-MM&#39;) = &#39;2014-01&#39;
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="joining-tables-inner">
<h2>Joining Tables – Inner<a class="headerlink" href="#joining-tables-inner" title="Permalink to this headline">¶</a></h2>
<p>Let us understand how to join data from multiple tables.</p>
<ul class="simple">
<li><p>We will primarily focus on ASCII style join (<strong>JOIN with ON</strong>).</p></li>
<li><p>There are different types of joins.</p>
<ul>
<li><p>INNER JOIN - Get all the records from both the datasets which satisfies JOIN condition.</p></li>
<li><p>OUTER JOIN - We will get into the details as part of the next topic</p></li>
</ul>
</li>
<li><p>Example for INNER JOIN</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">o</span><span class="o">.</span><span class="n">order_id</span><span class="p">,</span>
    <span class="n">o</span><span class="o">.</span><span class="n">order_date</span><span class="p">,</span>
    <span class="n">o</span><span class="o">.</span><span class="n">order_status</span><span class="p">,</span>
    <span class="n">oi</span><span class="o">.</span><span class="n">order_item_subtotal</span>
<span class="n">FROM</span> <span class="n">orders</span> <span class="n">o</span> <span class="n">JOIN</span> <span class="n">order_items</span> <span class="n">oi</span>
    <span class="n">ON</span> <span class="n">o</span><span class="o">.</span><span class="n">order_id</span> <span class="o">=</span> <span class="n">oi</span><span class="o">.</span><span class="n">order_item_order_id</span>
<span class="n">LIMIT</span> <span class="mi">10</span>
</pre></div>
</div>
<ul class="simple">
<li><p>We can join more than 2 tables in one query. Here is how it will look like.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">o</span><span class="o">.</span><span class="n">order_id</span><span class="p">,</span>
    <span class="n">o</span><span class="o">.</span><span class="n">order_date</span><span class="p">,</span>
    <span class="n">o</span><span class="o">.</span><span class="n">order_status</span><span class="p">,</span>
    <span class="n">oi</span><span class="o">.</span><span class="n">order_item_subtotal</span>
<span class="n">FROM</span> <span class="n">orders</span> <span class="n">o</span> <span class="n">JOIN</span> <span class="n">order_items</span> <span class="n">oi</span>
    <span class="n">ON</span> <span class="n">o</span><span class="o">.</span><span class="n">order_id</span> <span class="o">=</span> <span class="n">oi</span><span class="o">.</span><span class="n">order_item_order_id</span>
    <span class="n">JOIN</span> <span class="n">products</span> <span class="n">p</span>
    <span class="n">ON</span> <span class="n">p</span><span class="o">.</span><span class="n">product_id</span> <span class="o">=</span> <span class="n">oi</span><span class="o">.</span><span class="n">order_item_product_id</span>
<span class="n">LIMIT</span> <span class="mi">10</span>
</pre></div>
</div>
<ul class="simple">
<li><p>If we have to apply additional filters, it is recommended to use WHERE clause. ON clause should only have join conditions.</p></li>
<li><p>We can have non equal join conditions as well, but they are not used that often.</p></li>
<li><p>Here are some of the examples for INNER JOIN:</p>
<ul>
<li><p>Get order id, date, status and item revenue for all order items.</p></li>
<li><p>Get order id, date, status and item revenue for all order items for all orders where order status is either COMPLETE or CLOSED.</p></li>
<li><p>Get order id, date, status and item revenue for all order items for all orders where order status is either COMPLETE or CLOSED for the orders that are placed in the month of 2014 January.</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5433/itversity_retail_db
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT o.order_id,
    o.order_date,
    o.order_status,
    oi.order_item_subtotal
FROM orders o JOIN order_items oi
    ON o.order_id = oi.order_item_order_id
LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> SELECT count(1) FROM orders
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> SELECT count(1) FROM order_items
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT count(1)
FROM orders o JOIN order_items oi
    ON o.order_id = oi.order_item_order_id
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT o.order_id,
    o.order_date,
    o.order_status,
    oi.order_item_subtotal
FROM orders o JOIN order_items oi
    ON o.order_id = oi.order_item_order_id
WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT count(1)
FROM orders o JOIN order_items oi
    ON o.order_id = oi.order_item_order_id
WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT o.order_id,
    o.order_date,
    o.order_status,
    oi.order_item_subtotal
FROM orders o JOIN order_items oi
    ON o.order_id = oi.order_item_order_id
WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
    AND to_char(order_date, &#39;yyyy-MM&#39;) = &#39;2014-01&#39;
LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT count(1)
FROM orders o JOIN order_items oi
    ON o.order_id = oi.order_item_order_id
WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
    AND to_char(order_date, &#39;yyyy-MM&#39;) = &#39;2014-01&#39;
LIMIT 10
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="joining-tables-outer">
<h2>Joining Tables - Outer<a class="headerlink" href="#joining-tables-outer" title="Permalink to this headline">¶</a></h2>
<p>Let us understand how to perform outer joins using SQL. There are 3 different types of outer joins.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">LEFT</span> <span class="pre">OUTER</span> <span class="pre">JOIN</span></code> (default) - Get all the records from both the datasets which satisfies JOIN condition along with those records which are in the left side table but not in the right side table.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RIGHT</span> <span class="pre">OUTER</span> <span class="pre">JOIN</span></code> - Get all the records from both the datasets which satisfies JOIN condition along with those records which are in the right side table but not in the left side table.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">FULL</span> <span class="pre">OUTER</span> <span class="pre">JOIN</span></code> - left union right</p></li>
<li><p>When we perform the outer join (lets say left outer join), we will see this.</p>
<ul>
<li><p>Get all the values from both the tables when join condition satisfies.</p></li>
<li><p>If there are rows on left side tables for which there are no corresponding values in right side table, all the projected column values for right side table will be null.</p></li>
</ul>
</li>
<li><p>Here are some of the examples for outer join.</p>
<ul>
<li><p>Get all the orders where there are no corresponding order items.</p></li>
<li><p>Get all the order items where there are no corresponding orders.</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5433/itversity_retail_db
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT o.order_id,
    o.order_date,
    o.order_status,
    oi.order_item_order_id,
    oi.order_item_subtotal
FROM orders o LEFT OUTER JOIN order_items oi
    ON o.order_id = oi.order_item_order_id
LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT count(1)
FROM orders o LEFT OUTER JOIN order_items oi
    ON o.order_id = oi.order_item_order_id
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT o.order_id,
    o.order_date,
    o.order_status,
    oi.order_item_order_id,
    oi.order_item_subtotal
FROM orders o LEFT OUTER JOIN order_items oi
    ON o.order_id = oi.order_item_order_id
WHERE oi.order_item_order_id IS NULL
LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT count(1)
FROM orders o LEFT OUTER JOIN order_items oi
    ON o.order_id = oi.order_item_order_id
WHERE oi.order_item_order_id IS NULL
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT count(1)
FROM orders o LEFT OUTER JOIN order_items oi
    ON o.order_id = oi.order_item_order_id
WHERE oi.order_item_order_id IS NULL
    AND o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT o.order_id,
    o.order_date,
    o.order_status,
    oi.order_item_order_id,
    oi.order_item_subtotal
FROM orders o RIGHT OUTER JOIN order_items oi
    ON o.order_id = oi.order_item_order_id
LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT count(1)
FROM orders o RIGHT OUTER JOIN order_items oi
    ON o.order_id = oi.order_item_order_id
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT o.order_id,
    o.order_date,
    o.order_status,
    oi.order_item_order_id,
    oi.order_item_subtotal
FROM orders o RIGHT OUTER JOIN order_items oi
    ON o.order_id = oi.order_item_order_id
WHERE o.order_id IS NULL
LIMIT 10
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="performing-aggregations">
<h2>Performing Aggregations<a class="headerlink" href="#performing-aggregations" title="Permalink to this headline">¶</a></h2>
<p>Let us understand how to aggregate the data.</p>
<ul class="simple">
<li><p>We can perform global aggregations as well as aggregations by key.</p></li>
<li><p>Global Aggregations</p>
<ul>
<li><p>Get total number of orders.</p></li>
<li><p>Get revenue for a given order id.</p></li>
<li><p>Get number of records with order_status either COMPLETED or CLOSED.</p></li>
</ul>
</li>
<li><p>Aggregations by key - using <code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span></code></p>
<ul>
<li><p>Get number of orders by date or status.</p></li>
<li><p>Get revenue for each order_id.</p></li>
<li><p>Get daily product revenue (using order date and product id as keys).</p></li>
</ul>
</li>
<li><p>We can also use <code class="docutils literal notranslate"><span class="pre">HAVING</span></code> clause to apply filtering on top of aggregated data.</p>
<ul>
<li><p>Get daily product revenue where revenue is greater than $500 (using order date and product id as keys).</p></li>
</ul>
</li>
<li><p>Rules while using <code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span></code>.</p>
<ul>
<li><p>We can have the columns which are specified as part of <code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span></code> in <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> clause.</p></li>
<li><p>On top of those, we can have derived columns using aggregate functions.</p></li>
<li><p>We cannot have any other columns that are not used as part of <code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span></code> on derived column using non aggregate functions.</p></li>
<li><p>We will not be able to use aggregate functions or aliases used in the select clause as part of the where clause.</p></li>
<li><p>If we want to filter based on aggregated results, then we can leverage <code class="docutils literal notranslate"><span class="pre">HAVING</span></code> on top of <code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span></code> (specifying <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> is not an option)</p></li>
</ul>
</li>
<li><p>Typical query execution - FROM -&gt; WHERE -&gt; GROUP BY -&gt; SELECT</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5433/itversity_retail_db
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> SELECT count(order_id) FROM orders
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> SELECT count(DISTINCT order_date) FROM orders
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT round(sum(order_item_subtotal::numeric), 2) AS order_revenue
FROM order_items 
WHERE order_item_order_id = 2
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT count(1) 
FROM orders
WHERE order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT order_date,
    count(1)
FROM orders
GROUP BY order_date
LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT order_status,
    count(1) AS status_count
FROM orders
GROUP BY order_status
LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT order_item_order_id,
    round(sum(order_item_subtotal), 2) AS order_revenue
FROM order_items
GROUP BY order_item_order_id 
LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT o.order_date,
    oi.order_item_product_id,
    round(sum(oi.order_item_subtotal::numeric), 2) AS revenue
FROM orders o JOIN order_items oi
    ON o.order_id = oi.order_item_order_id
WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
GROUP BY o.order_date,
    oi.order_item_product_id
LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT o.order_date,
    oi.order_item_product_id,
    round(sum(oi.order_item_subtotal::numeric), 2) AS revenue
FROM orders o JOIN order_items oi
    ON o.order_id = oi.order_item_order_id
WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
    AND revenue &gt;= 500
GROUP BY o.order_date,
    oi.order_item_product_id
LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT o.order_date,
    oi.order_item_product_id,
    round(sum(oi.order_item_subtotal::numeric), 2) AS revenue
FROM orders o JOIN order_items oi
    ON o.order_id = oi.order_item_order_id
WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
GROUP BY o.order_date,
    oi.order_item_product_id
HAVING round(sum(oi.order_item_subtotal::numeric), 2) &gt;= 500
LIMIT 10
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="sorting-data">
<h2>Sorting Data<a class="headerlink" href="#sorting-data" title="Permalink to this headline">¶</a></h2>
<p>Let us understand how to sort the data using <strong>SQL</strong>.</p>
<ul class="simple">
<li><p>We typically perform sorting as final step.</p></li>
<li><p>Sorting can be done either by using one field or multiple fields.</p></li>
<li><p>We can sort the data either in ascending order or descending order by using column or expression.</p></li>
<li><p>By default, the sorting order is ascendig and we can change it to descending by using <code class="docutils literal notranslate"><span class="pre">DESC</span></code>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5433/itversity_retail_db
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM orders
ORDER BY order_customer_id
LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM orders
ORDER BY order_customer_id,
    order_date
LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT * FROM orders
ORDER BY order_customer_id,
    order_date DESC
LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT o.order_date,
    oi.order_item_product_id,
    round(sum(oi.order_item_subtotal::numeric), 2) AS revenue
FROM orders o JOIN order_items oi
    ON o.order_id = oi.order_item_order_id
WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
GROUP BY o.order_date,
    oi.order_item_product_id
ORDER BY o.order_date,
    revenue DESC
LIMIT 10
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="solution-daily-product-revenue">
<h2>Solution – Daily Product Revenue<a class="headerlink" href="#solution-daily-product-revenue" title="Permalink to this headline">¶</a></h2>
<p>Let us review the Final Solution for our problem statement <strong>daily_product_revenue</strong>.</p>
<ul class="simple">
<li><p>Prepare tables</p>
<ul>
<li><p>Create tables</p></li>
<li><p>Load the data into tables</p></li>
</ul>
</li>
<li><p>We need to project the fields which we are interested in.</p>
<ul>
<li><p>order_date</p></li>
<li><p>order_item_product_id</p></li>
<li><p>product_revenue</p></li>
</ul>
</li>
<li><p>As we have fields from multiple tables, we need to perform join after which we have to filter for COMPLETE or CLOSED orders.</p></li>
<li><p>We have to group the data by order_date and order_item_product_id, then we have to perform aggregation on order_item_subtotal to get product_revenue.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> sql
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">env</span> DATABASE_URL=postgresql://itversity_retail_user:retail_password@localhost:5433/itversity_retail_db
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT o.order_date,
    oi.order_item_product_id,
    round(sum(oi.order_item_subtotal::numeric), 2) AS product_revenue
FROM orders o JOIN order_items oi
    ON o.order_id = oi.order_item_order_id
WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
GROUP BY o.order_date,
    oi.order_item_product_id
LIMIT 10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">sql</span>

SELECT o.order_date,
    oi.order_item_product_id,
    round(sum(oi.order_item_subtotal::numeric), 2) AS product_revenue
FROM orders o JOIN order_items oi
    ON o.order_id = oi.order_item_order_id
WHERE o.order_status IN (&#39;COMPLETE&#39;, &#39;CLOSED&#39;)
GROUP BY o.order_date,
    oi.order_item_product_id
ORDER BY o.order_date,
    product_revenue DESC
LIMIT 10
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="exercises-basic-sql-queries">
<h2>Exercises - Basic SQL Queries<a class="headerlink" href="#exercises-basic-sql-queries" title="Permalink to this headline">¶</a></h2>
<p>Here are some of the exercises for which you can write SQL queries to self evaluate.</p>
<div class="section" id="exercise-1-customer-order-count">
<h3>Exercise 1 - Customer order count<a class="headerlink" href="#exercise-1-customer-order-count" title="Permalink to this headline">¶</a></h3>
<p>Get order count per customer for the month of 2014 January.</p>
<ul class="simple">
<li><p>Tables - orders and customers</p></li>
<li><p>Data should be sorted in descending order by count and ascending order by customer id.</p></li>
<li><p>Output should contain customer_id, customer_first_name, customer_last_name and customer_order_count.</p></li>
</ul>
</div>
<div class="section" id="exercise-2-dormant-customers">
<h3>Exercise 2 - Dormant Customers<a class="headerlink" href="#exercise-2-dormant-customers" title="Permalink to this headline">¶</a></h3>
<p>Get the customer details who have not placed any order for the month of 2014 January.</p>
<ul class="simple">
<li><p>Tables - orders and customers</p></li>
<li><p>Data should be sorted in ascending order by customer_id</p></li>
<li><p>Output should contain all the fields from customers</p></li>
</ul>
</div>
<div class="section" id="exercise-3-revenue-per-customer">
<h3>Exercise 3 - Revenue Per Customer<a class="headerlink" href="#exercise-3-revenue-per-customer" title="Permalink to this headline">¶</a></h3>
<p>Get the revenue generated by each customer for the month of 2014 January</p>
<ul class="simple">
<li><p>Tables - orders, order_items and customers</p></li>
<li><p>Data should be sorted in descending order by revenue and then ascending order by customer_id</p></li>
<li><p>Output should contain customer_id, customer_first_name, customer_last_name, customer_revenue.</p></li>
<li><p>If there are no orders placed by customer, then the corresponding revenue for a give customer should be 0.</p></li>
<li><p>Consider only COMPLETE and CLOSED orders</p></li>
</ul>
</div>
<div class="section" id="exercise-4-revenue-per-category">
<h3>Exercise 4 - Revenue Per Category<a class="headerlink" href="#exercise-4-revenue-per-category" title="Permalink to this headline">¶</a></h3>
<p>Get the revenue generated for each customer for the month of 2014 January</p>
<ul class="simple">
<li><p>Tables - orders, order_items, products and categories</p></li>
<li><p>Data should be sorted in ascending order by category_id.</p></li>
<li><p>Output should contain all the fields from category along with the revenue as category_revenue.</p></li>
<li><p>Consider only COMPLETE and CLOSED orders</p></li>
</ul>
</div>
</div>
<div class="section" id="exercise-5-product-count-per-department">
<h2>Exercise 5 - Product Count Per Department<a class="headerlink" href="#exercise-5-product-count-per-department" title="Permalink to this headline">¶</a></h2>
<p>Get the products for each department.</p>
<ul class="simple">
<li><p>Tables - departments, categories, products</p></li>
<li><p>Data should be sorted in ascending order by department_id</p></li>
<li><p>Output should contain all the fields from department and the product count as product_count</p></li>
</ul>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="01_getting_started.html" title="previous page">Getting Started</a>
    <a class='right-next' id="next-link" href="04_creating_tables_and_indexes.html" title="next page">Creating Tables and Indexes</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By The Jupyter Book community<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="_static/js/index.3da636dd464baa7582d2.js"></script>


    
  </body>
</html>